<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åº§å¸­æŠ½é¸ã‚¢ãƒ—ãƒªï¼ˆ6Ã—6ï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1, h2 { margin: 0 0 10px; }
    #students button { margin: 4px; padding: 6px 10px; border: 1px solid #ccc; background: #f8f8f8; cursor: pointer; }
    #students button.selected { background: #2d7ff9; color: #fff; border-color: #2d7ff9; }
    #students button.assigned { background: #aaa; color: #fff; cursor: not-allowed; }
    table { border-collapse: collapse; margin-top: 10px; }
    td { width: 90px; height: 40px; text-align: center; border: 1px solid #ccc; cursor: pointer; user-select: none; }
    td.inactive { background-color: #eee; color: #999; }
    td.assigned { background-color: #cfe9cf; }
    td.highlight { background-color: yellow; }
    .controls { margin: 10px 0; }
    .hint { color: #666; font-size: 0.9em; }
    #result { font-size: 2.2em; margin-top: 15px; }
  </style>
</head>
<body>
  <a href="seito.html">â¡ ç”Ÿå¾’åç™»éŒ²ãƒšãƒ¼ã‚¸ã¸</a>ã€€
  <h1>åº§å¸­æŠ½é¸ã‚¢ãƒ—ãƒªï¼ˆ6Ã—6ï¼‰</h1>

  <p class="hint">1) å‡ºå¸­ç•ªå·ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ 2) ã€Œåº§å¸­ç•ªå·ã‚’æŠ½é¸ã€ã‚’æŠ¼ã™ â†’ 3) å‡ºãŸç•ªå·ã®åº§å¸­ã«å‰²å½“ã¦ã€‚å¸­ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ä½¿ç”¨å¯/ä¸å¯ã‚’åˆ‡æ›¿ã§ãã¾ã™ï¼ˆON/OFFåˆ‡æ›¿ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ï¼‰ã€‚</p>

  <h2>å‡ºå¸­ç•ªå·ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</h2>
  <div id="students"></div>
  <p id="result"></p>

  <h2>åº§å¸­è¡¨ï¼ˆ6Ã—6ï¼‰</h2>
  <table id="seatMap"></table>

  <div class="controls">
    <button id="drawBtn">åº§å¸­ç•ªå·ã‚’æŠ½é¸</button>
    <button id="resetBtn">æŠ½é¸ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    <label style="margin-left:12px;">
      <input type="checkbox" id="toggleMode"> åº§å¸­ã®ON/OFFåˆ‡æ›¿ãƒ¢ãƒ¼ãƒ‰
    </label>
  </div>

  <script>
    const rows = 6, cols = 6;

    // åº§å¸­ä½¿ç”¨çŠ¶æ…‹
    let seatStatus = Array.from({ length: rows }, () => Array(cols).fill(true));
    const savedStatus = localStorage.getItem("seatStatus");
    if (savedStatus) {
      try {
        const parsed = JSON.parse(savedStatus);
        if (Array.isArray(parsed) && parsed.length === rows) seatStatus = parsed;
      } catch (e) {}
    }

    // ç”Ÿå¾’ä¸€è¦§
    let studentsData = [];
    const savedStudents = localStorage.getItem("studentList");
    if (savedStudents) {
      try {
        const parsed = JSON.parse(savedStudents);
        if (Array.isArray(parsed) && parsed.length > 0) studentsData = parsed;
      } catch (e) {}
    }
    if (studentsData.length === 0) {
      studentsData = Array.from({ length: rows * cols }, (_, i) => [String(i + 1), String(i + 1)]);
    }

    // å›ºå®šå¸­
    let fixedSeats = [];
    const savedFixed = localStorage.getItem("fixedSeats");
    if (savedFixed) {
      try { fixedSeats = JSON.parse(savedFixed); } catch (e) {}
    }

    // å›ºå®šå¸­ç•ªå·
    function getFixedSeatNums() {
      return fixedSeats.map(f => f.row * cols + f.col + 1);
    }

    let selectedNum = null;
    let availableSeats = [];
    function rebuildAvailableSeats() {
      availableSeats = [];
      const fixedSeatNums = getFixedSeatNums();
      let num = 1;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (seatStatus[r][c] && !fixedSeatNums.includes(num)) {
            availableSeats.push(num);
          }
          num++;
        }
      }
    }
    rebuildAvailableSeats();

    // å‰²å½“çµæœ
    let seatAssignments = {};

    // å‡ºå¸­ç•ªå·ãƒœã‚¿ãƒ³ç”Ÿæˆ
    const studentsDiv = document.getElementById("students");
    studentsData.forEach(([num, name]) => {
      const btn = document.createElement("button");
      btn.textContent = `${num}:${name}`;
      btn.dataset.num = num;
      btn.onclick = () => {
        if (Object.values(seatAssignments).includes(`${num}:${name}`)) {
          alert(`${name} ã•ã‚“ã¯ã™ã§ã«åº§å¸­ãŒå‰²ã‚Šå½“ã¦æ¸ˆã¿ã§ã™`);
          return;
        }
        Array.from(studentsDiv.children).forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedNum = num;
        document.getElementById("result").textContent = `é¸æŠä¸­ï¼š${num}:${name}`;
      };
      studentsDiv.appendChild(btn);
    });

    // åº§å¸­è¡¨æç”»ï¼ˆON/OFFã‚¯ãƒªãƒƒã‚¯å¯¾å¿œï¼‰
    function renderSeatMap() {
      const table = document.getElementById("seatMap");
      table.innerHTML = "";
      let seatNum = 1;
      const fixedSeatNums = getFixedSeatNums();

      for (let r = 0; r < rows; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < cols; c++) {
          const td = document.createElement("td");
          td.dataset.seat = seatNum;

          if (seatAssignments[seatNum]) {
            td.textContent = seatAssignments[seatNum];
            td.classList.add("assigned");
          } else {
            td.textContent = seatNum;
          }

          if (!seatStatus[r][c]) {
            td.classList.add("inactive");
          }

          // ON/OFFåˆ‡æ›¿ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒƒã‚¯å‹•ä½œ
          td.onclick = () => {
            const toggle = document.getElementById("toggleMode").checked;
            if (!toggle) return;

            // ã™ã§ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã®å¸­ã¯åˆ‡æ›¿ä¸å¯
            if (seatAssignments[seatNum]) {
              alert("ã“ã®å¸­ã«ã¯ã™ã§ã«å‰²ã‚Šå½“ã¦ãŒã‚ã‚Šã¾ã™ã€‚è§£é™¤ã—ã¦ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚");
              return;
            }
            // å›ºå®šå¸­ã¯åˆ‡æ›¿ä¸å¯ï¼ˆä»–ç”Ÿå¾’ã®èª¤å‰²å½“é˜²æ­¢ï¼‰
            if (fixedSeatNums.includes(seatNum)) {
              alert("ã“ã®å¸­ã¯ç‰¹å®šé…ç½®ï¼ˆå›ºå®šå¸­ï¼‰ã§ã™ã€‚ON/OFFã¯ç‰¹å®šé…ç½®ã®å¤‰æ›´å¾Œã«è¡Œã£ã¦ãã ã•ã„ã€‚");
              return;
            }

            // åˆ‡ã‚Šæ›¿ãˆ
            seatStatus[r][c] = !seatStatus[r][c];
            localStorage.setItem("seatStatus", JSON.stringify(seatStatus));
            rebuildAvailableSeats();
            renderSeatMap();
          };

          tr.appendChild(td);
          seatNum++;
        }
        table.appendChild(tr);
      }
    }
    renderSeatMap();

    // æŠ½é¸å‡¦ç†
    document.getElementById("drawBtn").onclick = () => {
      if (!selectedNum) {
        alert("ã¾ãšè‡ªåˆ†ã®å‡ºå¸­ç•ªå·ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const student = studentsData.find(([num]) => num === selectedNum);
      const label = `${student[0]}:${student[1]}`;

      if (Object.values(seatAssignments).includes(label)) {
        alert(`${label} ã•ã‚“ã¯ã™ã§ã«åº§å¸­ãŒå‰²ã‚Šå½“ã¦æ¸ˆã¿ã§ã™`);
        return;
      }

      const fixed = fixedSeats.find(f => f.name === student[1]);
      let finalSeatNum;
      if (fixed) {
        finalSeatNum = fixed.row * cols + fixed.col + 1;
        // å›ºå®šå¸­ãŒOFFã ã£ãŸå ´åˆã®ä¿è­·
        if (!seatStatus[fixed.row]?.[fixed.col]) {
          alert("ã“ã®ç”Ÿå¾’ã®å›ºå®šå¸­ãŒOFFã«ãªã£ã¦ã„ã¾ã™ã€‚åº§å¸­è¨­å®šã‚’ONã«ã—ã¦ã‹ã‚‰æŠ½é¸ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
      } else {
        const fixedSeatNums = getFixedSeatNums();
        const remaining = availableSeats.filter(n => !seatAssignments[n] && !fixedSeatNums.includes(n));
        if (remaining.length === 0) {
          alert("ç©ºãåº§å¸­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }
        finalSeatNum = remaining[Math.floor(Math.random() * remaining.length)];
      }

      // ç¢ºå®šå‡¦ç†
      seatAssignments[finalSeatNum] = label;
      renderSeatMap();
      document.getElementById("result").textContent = `${label} ã•ã‚“ã®åº§å¸­ç•ªå·ã¯ ${finalSeatNum} ã§ã™ ğŸ‰`;

      Array.from(studentsDiv.children).forEach(b => {
        if (b.dataset.num === selectedNum) {
          b.classList.remove("selected");
          b.classList.add("assigned");
        }
      });
      selectedNum = null;
    };

    // ãƒªã‚»ãƒƒãƒˆå‡¦ç†ï¼ˆON/OFFã¯ä¿æŒï¼‰
    document.getElementById("resetBtn").onclick = () => {
      if (!confirm("æŠ½é¸çµæœã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ï¼ˆåº§å¸­ã®ON/OFFè¨­å®šã¯ãã®ã¾ã¾ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      seatAssignments = {};
      rebuildAvailableSeats();
      selectedNum = null;
      Array.from(studentsDiv.children).forEach(b => {
        b.classList.remove("selected");
        b.classList.remove("assigned");
      });
      document.getElementById("result").textContent = "";
      renderSeatMap();
    };
  </script>
</body>
</html>
